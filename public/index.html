<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Painel de Estudos - Rumo à Aprovação Fiscal</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			body {
				font-family: 'Inter', sans-serif;
			}
			.tab-active {
				border-bottom: 2px solid #4f46e5;
				color: #4f46e5;
				font-weight: 600;
			}
			.highlight-day {
				background-color: #e0e7ff;
				color: #1e293b;
			}
			.timer-display {
				font-size: 4rem;
				line-height: 1;
			}
			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0, 0, 0, 0.6);
			}
			.modal-content {
				background-color: #1e293b;
				margin: 10% auto;
				padding: 2rem;
				border: 1px solid #475569;
				width: 90%;
				max-width: 600px;
				border-radius: 0.5rem;
				color: #e2e8f0;
			}
			.close-button {
				color: #94a3b8;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}
		</style>
	</head>
	<body class="bg-slate-900 text-white">
		<!-- Login View -->
		<div
			id="login-view"
			class="min-h-screen flex flex-col items-center justify-center text-center p-4"
		>
			<h1 class="text-4xl md:text-5xl font-bold text-indigo-400 mb-4">
				Painel de Estudos Fiscal
			</h1>
			<p class="text-slate-400 mb-8 max-w-xl">
				Sua ferramenta de estudos inteligente e sincronizada. Acesse seu
				progresso de qualquer dispositivo.
			</p>
			<button
				onclick="loginWithGoogle()"
				class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg flex items-center space-x-3 text-lg"
			>
				<svg class="w-6 h-6" viewBox="0 0 48 48">
					<path
						fill="#FFC107"
						d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
					></path>
					<path
						fill="#FF3D00"
						d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
					></path>
					<path
						fill="#4CAF50"
						d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
					></path>
					<path
						fill="#1976D2"
						d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.62,44,31.023,44,24C44,22.659,43.862,21.35,43.611,20.083z"
					></path>
				</svg>
				<span>Login com Google</span>
			</button>
		</div>

		<!-- Main App View -->
		<div id="app-view" class="hidden container mx-auto p-4 md:p-8">
			<header class="flex justify-between items-center mb-8">
				<div class="text-left">
					<h1 class="text-3xl md:text-4xl font-bold text-indigo-400">
						Painel de Estudos
					</h1>
					<p class="text-slate-400">Rumo à Aprovação Fiscal</p>
				</div>
				<div id="user-profile" class="flex items-center space-x-4">
					<!-- User info will be injected here -->
				</div>
			</header>

			<main id="main-content">
				<!-- Tabs -->
				<div class="mb-8 border-b border-slate-700">
					<nav class="flex space-x-4" aria-label="Tabs">
						<button
							id="tab-dashboard"
							class="tab-active py-4 px-1 text-sm font-medium text-slate-300 hover:text-indigo-400"
							onclick="showTab('dashboard')"
						>
							Painel Principal
						</button>
						<button
							id="tab-schedule"
							class="py-4 px-1 text-sm font-medium text-slate-300 hover:text-indigo-400"
							onclick="showTab('schedule')"
						>
							Cronograma
						</button>
						<button
							id="tab-stats"
							class="py-4 px-1 text-sm font-medium text-slate-300 hover:text-indigo-400"
							onclick="showTab('stats')"
						>
							Estatísticas
						</button>
					</nav>
				</div>

				<!-- Content sections... (same as before) -->
				<div id="content-dashboard">
					<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
						<!-- Study Session -->
						<div class="lg:col-span-2 bg-slate-800 p-6 rounded-lg shadow-lg">
							<h2 class="text-2xl font-bold mb-4 text-indigo-400">
								Próxima Sessão
							</h2>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
								<!-- Timer -->
								<div
									class="flex flex-col items-center justify-center bg-slate-900 p-6 rounded-lg"
								>
									<p
										id="timer-mode"
										class="text-lg font-semibold text-slate-400 mb-2"
									>
										Foco
									</p>
									<div
										id="timer"
										class="timer-display font-bold text-indigo-300"
									>
										50:00
									</div>
									<div class="flex space-x-4 mt-4">
										<button
											id="start-btn"
											onclick="timer.start()"
											class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
										>
											Iniciar
										</button>
										<button
											id="pause-btn"
											onclick="timer.pause()"
											class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition-colors"
										>
											Pausar
										</button>
										<button
											id="reset-btn"
											onclick="timer.reset()"
											class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"
										>
											Resetar
										</button>
									</div>
								</div>
								<!-- Session Form -->
								<div class="space-y-4">
									<div>
										<label class="block text-sm font-medium text-slate-300"
											>Matéria Atual</label
										>
										<p
											id="current-subject"
											class="mt-1 text-xl font-semibold text-white bg-slate-700 p-3 rounded-md"
										>
											Carregando...
										</p>
									</div>
									<div>
										<label
											for="topic"
											class="block text-sm font-medium text-slate-300"
											>Tópico Estudado</label
										>
										<div class="flex items-center space-x-2 mt-1">
											<input
												type="text"
												id="topic"
												class="block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
												placeholder="Ex: Balanço Patrimonial"
											/>
											<button
												id="generate-questions-btn"
												onclick="generateQuestions()"
												class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-2 rounded-lg transition-colors"
												title="Gerar questões sobre este tópico com IA"
											>
												✨
											</button>
										</div>
									</div>
									<div class="grid grid-cols-2 gap-4">
										<div>
											<label
												for="correct"
												class="block text-sm font-medium text-slate-300"
												>Acertos</label
											>
											<input
												type="number"
												id="correct"
												value="0"
												min="0"
												class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
											/>
										</div>
										<div>
											<label
												for="errors"
												class="block text-sm font-medium text-slate-300"
												>Erros</label
											>
											<input
												type="number"
												id="errors"
												value="0"
												min="0"
												class="mt-1 block w-full bg-slate-700 border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
											/>
										</div>
									</div>
									<div class="flex flex-col space-y-3">
										<button
											onclick="completeAndAdvance()"
											class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors"
										>
											Concluir e Avançar
										</button>
										<button
											onclick="skipSession()"
											class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm"
										>
											Pular Sessão (Deixar para depois)
										</button>
									</div>
								</div>
							</div>
						</div>
						<!-- Today's Summary -->
						<div class="bg-slate-800 p-6 rounded-lg shadow-lg">
							<h2 class="text-2xl font-bold mb-4 text-indigo-400">
								Resumo do Dia
							</h2>
							<div class="space-y-4">
								<div
									class="flex justify-between items-center bg-slate-900 p-4 rounded-lg"
								>
									<span class="text-slate-300">Tempo de Estudo Hoje:</span>
									<span
										id="today-study-time"
										class="text-xl font-bold text-indigo-300"
										>0h 0m</span
									>
								</div>
								<div
									class="flex justify-between items-center bg-slate-900 p-4 rounded-lg"
								>
									<span class="text-slate-300">Sessões Concluídas:</span>
									<span
										id="today-sessions-count"
										class="text-xl font-bold text-indigo-300"
										>0</span
									>
								</div>
								<div
									class="flex justify-between items-center bg-slate-900 p-4 rounded-lg"
								>
									<span class="text-slate-300">Acertos / Erros Hoje:</span>
									<span
										id="today-questions-stats"
										class="text-xl font-bold text-indigo-300"
										>0 / 0</span
									>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div
					id="content-schedule"
					class="hidden bg-slate-800 p-6 rounded-lg shadow-lg"
				>
					<h2 class="text-2xl font-bold mb-4 text-indigo-400">
						Cronograma Dinâmico
					</h2>
					<div id="dynamic-schedule-container" class="overflow-x-auto">
						<p class="text-slate-400">Carregando cronograma...</p>
					</div>
				</div>
				<div id="content-stats" class="hidden">
					<div
						class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
					>
						<div class="bg-slate-800 p-5 rounded-lg shadow-lg text-center">
							<h3 class="text-sm font-medium text-slate-400">
								Tempo Total de Estudo
							</h3>
							<p
								id="total-study-time"
								class="mt-1 text-3xl font-semibold text-indigo-300"
							>
								0h 0m
							</p>
						</div>
						<div class="bg-slate-800 p-5 rounded-lg shadow-lg text-center">
							<h3 class="text-sm font-medium text-slate-400">
								Total de Questões
							</h3>
							<p
								id="total-questions"
								class="mt-1 text-3xl font-semibold text-indigo-300"
							>
								0
							</p>
						</div>
						<div class="bg-slate-800 p-5 rounded-lg shadow-lg text-center">
							<h3 class="text-sm font-medium text-slate-400">Acertos</h3>
							<p
								id="total-correct"
								class="mt-1 text-3xl font-semibold text-green-400"
							>
								0
							</p>
						</div>
						<div class="bg-slate-800 p-5 rounded-lg shadow-lg text-center">
							<h3 class="text-sm font-medium text-slate-400">
								Taxa de Acerto Geral
							</h3>
							<p
								id="overall-accuracy"
								class="mt-1 text-3xl font-semibold text-green-400"
							>
								0%
							</p>
						</div>
					</div>
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
						<div class="bg-slate-800 p-6 rounded-lg shadow-lg">
							<h3 class="text-lg font-semibold mb-4 text-indigo-400">
								Tempo de Estudo por Matéria
							</h3>
							<canvas id="time-chart"></canvas>
						</div>
						<div class="bg-slate-800 p-6 rounded-lg shadow-lg">
							<h3 class="text-lg font-semibold mb-4 text-indigo-400">
								Taxa de Acerto por Matéria
							</h3>
							<canvas id="accuracy-chart"></canvas>
						</div>
					</div>
					<div class="bg-slate-800 p-6 rounded-lg shadow-lg">
						<h2 class="text-2xl font-bold mb-4 text-indigo-400">
							Histórico de Sessões
						</h2>
						<div class="overflow-x-auto">
							<table class="min-w-full divide-y divide-slate-700">
								<thead class="bg-slate-900">
									<tr>
										<th
											class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white"
										>
											Data
										</th>
										<th
											class="px-3 py-3.5 text-left text-sm font-semibold text-white"
										>
											Matéria
										</th>
										<th
											class="px-3 py-3.5 text-left text-sm font-semibold text-white"
										>
											Tópico
										</th>
										<th
											class="px-3 py-3.5 text-left text-sm font-semibold text-white"
										>
											Tempo
										</th>
										<th
											class="px-3 py-3.5 text-left text-sm font-semibold text-white"
										>
											Questões
										</th>
										<th
											class="px-3 py-3.5 text-left text-sm font-semibold text-white"
										>
											% Acerto
										</th>
									</tr>
								</thead>
								<tbody
									id="session-log-body"
									class="divide-y divide-slate-700"
								></tbody>
							</table>
						</div>
					</div>
				</div>
			</main>
		</div>

		<div id="questions-modal" class="modal">
			<div class="modal-content">
				<span class="close-button" onclick="closeModal()">&times;</span>
				<h2 class="text-2xl font-bold mb-4 text-purple-400">
					✨ Questões Geradas por IA
				</h2>
				<div id="modal-body" class="text-sm leading-relaxed"></div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

		<script type="module">
			import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
			import {
				getFirestore,
				collection,
				addDoc,
				onSnapshot,
				query,
				doc,
				getDoc,
				setDoc,
				updateDoc,
				increment,
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
			import {
				getAuth,
				onAuthStateChanged,
				GoogleAuthProvider,
				signInWithPopup,
				signOut,
			} from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

			const firebaseConfig = {
				apiKey: 'AIzaSyCHAIxCxmwoMdvvdH0Zfx5nJGKeLxbLT4M',
				authDomain: 'meu-painel-de-estudos-6929c.firebaseapp.com',
				projectId: 'meu-painel-de-estudos-6929c',
				storageBucket: 'meu-painel-de-estudos-6929c.firebasestorage.app',
				messagingSenderId: '493458997775',
				appId: '1:493458997775:web:e8fb05c376aeef14b9997a',
			};

			const app = initializeApp(firebaseConfig);
			const db = getFirestore(app);
			const auth = getAuth(app);
			const provider = new GoogleAuthProvider();

			let userId = null;
			let stateRef, sessionsCollectionRef;
			let unsubscribeSessions, unsubscribeState;

			const cycle = [
				'Contabilidade Geral',
				'Direito Constitucional',
				'Tecnologia da Informação',
				'Português',
				'Direito Administrativo',
				'Contabilidade Geral',
				'Raciocínio Lógico',
				'Direito Tributário',
				'Tecnologia da Informação',
				'Direito Constitucional',
				'Contabilidade Geral',
				'Direito Administrativo',
				'Tecnologia da Informação',
				'Direito Tributário',
			];

			let appState = {
				sessions: [],
				currentCycleIndex: 0,
			};

			const loginView = document.getElementById('login-view');
			const appView = document.getElementById('app-view');
			const userProfileEl = document.getElementById('user-profile');
			const topicEl = document.getElementById('topic');
			const correctEl = document.getElementById('correct');
			const errorsEl = document.getElementById('errors');
			const modal = document.getElementById('questions-modal');
			const modalBody = document.getElementById('modal-body');
			const generateBtn = document.getElementById('generate-questions-btn');

			let timeChart, accuracyChart;
			const chartColors = [
				'#818cf8',
				'#60a5fa',
				'#34d399',
				'#facc15',
				'#fb923c',
				'#f87171',
				'#a78bfa',
			];

			onAuthStateChanged(auth, async (user) => {
				if (user) {
					userId = user.uid;
					loginView.style.display = 'none';
					appView.style.display = 'block';

					userProfileEl.innerHTML = `
                    <span class="text-slate-300 text-sm hidden md:block">${user.displayName}</span>
                    <img src="${user.photoURL}" alt="Foto do Perfil" class="w-10 h-10 rounded-full">
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Sair</button>
                `;

					// CORREÇÃO: Usando um caminho consistente para os dados do usuário.
					// Isso garante que as regras de segurança padrão do Firebase permitam o acesso.
					stateRef = doc(db, `users/${userId}/state/main_state`);
					sessionsCollectionRef = collection(
						db,
						`users/${userId}/study_sessions`
					);

					await initState();
					listenForData();
				} else {
					userId = null;
					loginView.style.display = 'flex';
					appView.style.display = 'none';
					if (unsubscribeSessions) unsubscribeSessions();
					if (unsubscribeState) unsubscribeState();
				}
			});

			window.loginWithGoogle = async () => {
				try {
					await signInWithPopup(auth, provider);
				} catch (error) {
					console.error('Erro no login com Google:', error);
				}
			};

			window.logout = async () => {
				try {
					await signOut(auth);
				} catch (error) {
					console.error('Erro no logout:', error);
				}
			};

			async function initState() {
				try {
					const stateSnap = await getDoc(stateRef);
					if (!stateSnap.exists()) {
						await setDoc(stateRef, { currentCycleIndex: 0 });
					}
				} catch (error) {
					console.error('Erro ao inicializar o estado: ', error);
				}
			}

			function listenForData() {
				if (unsubscribeSessions) unsubscribeSessions();
				if (unsubscribeState) unsubscribeState();

				unsubscribeState = onSnapshot(
					stateRef,
					(doc) => {
						appState.currentCycleIndex = doc.data()?.currentCycleIndex || 0;
						updateUI();
					},
					(error) => {
						console.error('Erro ao ouvir o estado:', error);
						document.getElementById('current-subject').textContent =
							'Erro ao carregar';
						document.getElementById('dynamic-schedule-container').innerHTML =
							'<p class="text-red-400">Falha ao carregar o cronograma.</p>';
					}
				);

				unsubscribeSessions = onSnapshot(
					query(sessionsCollectionRef),
					(snapshot) => {
						const sessions = [];
						snapshot.forEach((doc) =>
							sessions.push({ id: doc.id, ...doc.data() })
						);
						appState.sessions = sessions.sort(
							(a, b) => b.timestamp.toMillis() - a.timestamp.toMillis()
						);
						updateUI();
					},
					(error) => {
						console.error('Erro ao ouvir as sessões:', error);
					}
				);
			}

			function updateUI() {
				if (!userId) return;
				const currentSubject = cycle[appState.currentCycleIndex % cycle.length];
				document.getElementById('current-subject').textContent = currentSubject;
				updateDashboard(appState.sessions);
				updateStats(appState.sessions);
				updateSessionLog(appState.sessions);
				renderDynamicSchedule(appState.currentCycleIndex);
			}

			function updateDashboard(sessions) {
				const today = new Date().setHours(0, 0, 0, 0);
				const todaySessions = sessions.filter(
					(s) => s.timestamp.toDate().setHours(0, 0, 0, 0) === today
				);
				const todayStudyTime = todaySessions.reduce(
					(acc, s) => acc + s.duration,
					0
				);
				document.getElementById('today-study-time').textContent =
					formatTime(todayStudyTime);
				document.getElementById('today-sessions-count').textContent =
					todaySessions.length;
				const todayCorrect = todaySessions.reduce(
					(acc, s) => acc + s.correct,
					0
				);
				const todayErrors = todaySessions.reduce((acc, s) => acc + s.errors, 0);
				document.getElementById(
					'today-questions-stats'
				).textContent = `${todayCorrect} / ${todayErrors}`;
			}

			function updateStats(sessions) {
				const totalTime = sessions.reduce((acc, s) => acc + s.duration, 0);
				const totalCorrect = sessions.reduce((acc, s) => acc + s.correct, 0);
				const totalErrors = sessions.reduce((acc, s) => acc + s.errors, 0);
				const totalQuestions = totalCorrect + totalErrors;
				const overallAccuracy =
					totalQuestions > 0
						? ((totalCorrect / totalQuestions) * 100).toFixed(1)
						: 0;
				document.getElementById('total-study-time').textContent =
					formatTime(totalTime);
				document.getElementById('total-questions').textContent = totalQuestions;
				document.getElementById('total-correct').textContent = totalCorrect;
				document.getElementById(
					'overall-accuracy'
				).textContent = `${overallAccuracy}%`;
				updateCharts(sessions);
			}

			function updateSessionLog(sessions) {
				const logBody = document.getElementById('session-log-body');
				logBody.innerHTML = '';
				if (sessions.length === 0) {
					logBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-slate-400">Nenhuma sessão registrada ainda.</td></tr>`;
					return;
				}
				sessions.forEach((s) => {
					const date = s.timestamp.toDate().toLocaleDateString('pt-BR');
					const totalQ = s.correct + s.errors;
					const accuracy =
						totalQ > 0 ? ((s.correct / totalQ) * 100).toFixed(0) : 'N/A';
					logBody.innerHTML += `<tr class="hover:bg-slate-700"><td class="py-4 pl-4 pr-3 text-sm font-medium text-white sm:pl-6">${date}</td><td class="px-3 py-4 text-sm text-slate-300">${
						s.subject
					}</td><td class="px-3 py-4 text-sm text-slate-300">${
						s.topic
					}</td><td class="px-3 py-4 text-sm text-slate-300">${formatTime(
						s.duration
					)}</td><td class="px-3 py-4 text-sm text-slate-300">${totalQ}</td><td class="px-3 py-4 text-sm text-slate-300">${accuracy}%</td></tr>`;
				});
			}

			function updateCharts(sessions) {
				if (typeof Chart === 'undefined') return;
				const statsBySubject = {};
				cycle.forEach((sub) => {
					if (!statsBySubject[sub])
						statsBySubject[sub] = { time: 0, correct: 0, errors: 0 };
				});
				sessions.forEach((s) => {
					if (statsBySubject[s.subject]) {
						statsBySubject[s.subject].time += s.duration;
						statsBySubject[s.subject].correct += s.correct;
						statsBySubject[s.subject].errors += s.errors;
					}
				});
				const timeData = {
					labels: Object.keys(statsBySubject),
					datasets: [
						{
							data: Object.values(statsBySubject).map((s) => s.time / 60),
							backgroundColor: chartColors,
							borderColor: '#1e293b',
						},
					],
				};
				const accuracyData = {
					labels: Object.keys(statsBySubject),
					datasets: [
						{
							label: '% de Acerto',
							data: Object.values(statsBySubject).map((s) => {
								const totalQ = s.correct + s.errors;
								return totalQ > 0 ? (s.correct / totalQ) * 100 : 0;
							}),
							backgroundColor: chartColors,
							borderColor: '#1e293b',
							borderWidth: 1,
						},
					],
				};
				const timeCtx = document.getElementById('time-chart').getContext('2d');
				if (timeChart) timeChart.destroy();
				timeChart = new Chart(timeCtx, {
					type: 'doughnut',
					data: timeData,
					options: {
						responsive: true,
						plugins: {
							legend: { position: 'top', labels: { color: '#cbd5e1' } },
						},
					},
				});
				const accuracyCtx = document
					.getElementById('accuracy-chart')
					.getContext('2d');
				if (accuracyChart) accuracyChart.destroy();
				accuracyChart = new Chart(accuracyCtx, {
					type: 'bar',
					data: accuracyData,
					options: {
						responsive: true,
						scales: {
							y: {
								beginAtZero: true,
								max: 100,
								ticks: { color: '#94a3b8' },
								grid: { color: '#334155' },
							},
							x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
						},
						plugins: { legend: { display: false } },
					},
				});
			}

			function formatTime(seconds) {
				if (!seconds || seconds < 60) return `~1m`;
				const h = Math.floor(seconds / 3600);
				const m = Math.floor((seconds % 3600) / 60);
				return `${h > 0 ? h + 'h ' : ''}${m}m`;
			}

			function renderDynamicSchedule(startIndex) {
				const container = document.getElementById('dynamic-schedule-container');
				const days = [
					'Segunda',
					'Terça',
					'Quarta',
					'Quinta',
					'Sexta',
					'Sábado',
				];
				const todayIndex = (new Date().getDay() + 6) % 7;
				let html = `<table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-900"><tr><th class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white sm:pl-6">Dia</th><th class="px-3 py-3.5 text-left text-sm font-semibold text-white">Sessão 1</th><th class="px-3 py-3.5 text-left text-sm font-semibold text-white">Sessão 2</th><th class="px-3 py-3.5 text-left text-sm font-semibold text-white">Sessão 3</th><th class="px-3 py-3.5 text-left text-sm font-semibold text-white">Sessão 4</th></tr></thead><tbody class="divide-y divide-slate-700">`;
				let cycleIndex = startIndex;
				for (let day = 0; day < days.length; day++) {
					const isToday = day === todayIndex;
					html += `<tr class="${
						isToday ? 'highlight-day' : ''
					}"><td class="py-4 pl-4 pr-3 text-sm font-medium sm:pl-6">${
						days[day]
					}</td>`;
					for (let session = 0; session < 4; session++) {
						html += `<td class="px-3 py-4 text-sm">${
							cycle[cycleIndex % cycle.length]
						}</td>`;
						cycleIndex++;
					}
					html += `</tr>`;
				}
				html += `</tbody></table>`;
				container.innerHTML = html;
			}

			async function advanceCycle() {
				try {
					await updateDoc(stateRef, { currentCycleIndex: increment(1) });
					topicEl.value = '';
					correctEl.value = '0';
					errorsEl.value = '0';
					timer.reset();
				} catch (e) {
					console.error('Error advancing cycle: ', e);
				}
			}

			window.completeAndAdvance = async function () {
				const duration = timer.getStudyTime();
				if (duration < 60) {
					alert('Sessão muito curta.');
					return;
				}
				const sessionData = {
					subject: cycle[appState.currentCycleIndex % cycle.length],
					topic: topicEl.value || 'Tópico não especificado',
					duration: duration,
					correct: parseInt(correctEl.value) || 0,
					errors: parseInt(errorsEl.value) || 0,
					timestamp: new Date(),
				};
				try {
					await addDoc(sessionsCollectionRef, sessionData);
					await advanceCycle();
					if (window.Tone) {
						new Tone.Synth()
							.toDestination()
							.triggerAttackRelease('C5', '8n', Tone.now());
					}
				} catch (e) {
					console.error('Error saving session: ', e);
				}
			};

			window.skipSession = async function () {
				await advanceCycle();
			};

			window.generateQuestions = async function () {
				const subject = cycle[appState.currentCycleIndex % cycle.length];
				const topic = topicEl.value;
				if (!topic) {
					alert('Insira um tópico.');
					return;
				}
				modal.style.display = 'block';
				modalBody.innerHTML = '<p>Gerando questões...</p>';
				generateBtn.disabled = true;
				generateBtn.innerHTML = '...';
				const prompt = `Você é um especialista em criar questões para concursos da área fiscal no Brasil. Crie 3 questões de múltipla escolha (com 4 alternativas: A, B, C, D) sobre o seguinte tópico de "${subject}": "${topic}". As questões devem ser desafiadoras e no estilo de bancas como FCC e FGV. No final, inclua uma seção "Gabarito" com as respostas corretas.`;
				const payload = {
					contents: [{ role: 'user', parts: [{ text: prompt }] }],
				};
				const apiKey = '';
				const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
				try {
					const response = await fetch(apiUrl, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload),
					});
					if (!response.ok)
						throw new Error(
							`API request failed with status ${response.status}`
						);
					const result = await response.json();
					if (result.candidates && result.candidates.length > 0) {
						modalBody.innerHTML =
							result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
					} else {
						throw new Error('Resposta da API inválida.');
					}
				} catch (error) {
					console.error('Gemini API error:', error);
					modalBody.innerHTML = `<p class="text-red-400">Ocorreu um erro. Detalhes: ${error.message}</p>`;
				} finally {
					generateBtn.disabled = false;
					generateBtn.innerHTML = '✨';
				}
			};

			window.closeModal = function () {
				modal.style.display = 'none';
			};

			window.timer = {
				FOCUS_TIME: 50 * 60,
				BREAK_TIME: 10 * 60,
				currentTime: 50 * 60,
				interval: null,
				isPaused: true,
				isFocusMode: true,
				totalStudyTime: 0,
				start() {
					if (!this.interval) {
						this.isPaused = false;
						this.interval = setInterval(() => this.update(), 1000);
						document.getElementById('start-btn').disabled = true;
						document.getElementById('pause-btn').disabled = false;
					}
				},
				pause() {
					this.isPaused = true;
					clearInterval(this.interval);
					this.interval = null;
					document.getElementById('start-btn').disabled = false;
					document.getElementById('pause-btn').disabled = true;
				},
				reset() {
					this.pause();
					this.isFocusMode = true;
					this.currentTime = this.FOCUS_TIME;
					this.totalStudyTime = 0;
					this.display();
					document.getElementById('timer-mode').textContent = 'Foco';
				},
				update() {
					if (!this.isPaused) {
						this.currentTime--;
						if (this.isFocusMode) {
							this.totalStudyTime++;
						}
						if (this.currentTime < 0) {
							this.switchMode();
						}
						this.display();
					}
				},
				switchMode() {
					this.isFocusMode = !this.isFocusMode;
					this.currentTime = this.isFocusMode
						? this.FOCUS_TIME
						: this.BREAK_TIME;
					document.getElementById('timer-mode').textContent = this.isFocusMode
						? 'Foco'
						: 'Descanso';
					if (window.Tone) {
						new Tone.Synth()
							.toDestination()
							.triggerAttackRelease('C4', '8n', Tone.now());
					}
				},
				display() {
					const m = Math.floor(this.currentTime / 60);
					const s = this.currentTime % 60;
					document.getElementById('timer').textContent = `${String(m).padStart(
						2,
						'0'
					)}:${String(s).padStart(2, '0')}`;
				},
				getStudyTime() {
					return this.totalStudyTime;
				},
			};

			window.showTab = function (tabName) {
				['dashboard', 'schedule', 'stats'].forEach((id) => {
					document.getElementById(`content-${id}`).style.display = 'none';
					document.getElementById(`tab-${id}`).classList.remove('tab-active');
				});
				document.getElementById(`content-${tabName}`).style.display = 'block';
				document.getElementById(`tab-${tabName}`).classList.add('tab-active');
			};
		</script>
	</body>
</html>
